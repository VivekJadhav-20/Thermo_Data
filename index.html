<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üî• Thermocouple Dashboard ‚Äî Dark Neon</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#071019;
      --panel:#0b1420;
      --muted:#98a8b9;
      --neon-blue: #00c2ff;
      --neon-orange: #ff7a2d;
      --glass: rgba(255,255,255,0.03);
      --accent-glow: 0 8px 30px rgba(0,194,255,0.06);
      --radius:16px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,194,255,0.02), transparent 8%),
                  radial-gradient(900px 400px at 95% 90%, rgba(255,122,64,0.02), transparent 8%),
                  var(--bg);
      color:#dbe9f6;
      padding:28px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{display:flex; align-items:center; justify-content:space-between; gap:20px; margin-bottom:22px}
    .title {display:flex; align-items:center; gap:14px}
    .logo {height:56px; width:56px; border-radius:12px; background: linear-gradient(135deg,var(--neon-blue), #004f6b);
           box-shadow: 0 8px 30px rgba(0,194,255,0.12), inset 0 -6px 18px rgba(0,0,0,0.25);
           display:flex; align-items:center; justify-content:center; font-weight:800; color:#02121a; font-size:20px;}
    h1{font-size:1.35rem; letter-spacing:0.2px}
    .subtitle{font-size:0.85rem; color:var(--muted); margin-top:2px}

    .status{display:flex; align-items:center; gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,0.04);
      box-shadow: var(--accent-glow); font-weight:600;}
    .led {width:10px;height:10px;border-radius:50%;box-shadow:0 0 8px rgba(0,0,0,0.6)}
    .led.live { background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue);}
    .led.off { background: #333; box-shadow:none; opacity:0.6 }

    .grid {display:grid; grid-template-columns: repeat(12, 1fr); gap:18px; align-items:start;}
    .cards {grid-column: span 4; display:flex; flex-direction:column; gap:16px; min-width:230px;}
    .card {background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
      border: 1px solid rgba(255,255,255,0.03); border-radius: var(--radius); padding:18px;
      box-shadow: 0 12px 30px rgba(2,14,22,0.6); position:relative; overflow:hidden;
      transition: transform 220ms ease, box-shadow 220ms ease; backdrop-filter: blur(6px);}
    .card:hover{ transform: translateY(-6px); box-shadow: 0 20px 48px rgba(0,0,0,0.7) }

    .label { color:var(--muted); font-size:0.92rem; font-weight:600; letter-spacing:0.6px }
    .value {margin-top:8px; font-size:2.6rem; font-weight:800; line-height:1;
      color: var(--neon-blue); display:flex; align-items:baseline; gap:10px;
      text-shadow: 0 6px 32px rgba(0,194,255,0.08); transition: color 180ms ease;}
    .unit { font-size:0.85rem; font-weight:600; color:var(--muted) }
    .max { margin-top:8px; color:var(--neon-orange); font-weight:700 }

    .card.warn .value { color: #ffd86b; text-shadow: 0 8px 30px rgba(255,216,107,0.08) }
    .card.danger .value { color: #ff4d4d; text-shadow: 0 8px 36px rgba(255,77,77,0.12) }
    .pulse { animation: pulse 1100ms ease-in-out infinite;}
    @keyframes pulse {0% { transform: scale(1); opacity:1 } 50% { transform: scale(1.02); opacity:0.95 } 100% { transform: scale(1); opacity:1 }}

    .panel {grid-column: span 8; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:16px; border-radius:18px; border:1px solid rgba(255,255,255,0.03); box-shadow: 0 14px 40px rgba(0,0,0,0.6);}
    .panel-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px }
    .panel-title { font-weight:700 }
    .meta { color:var(--muted); font-size:0.86rem }
    canvas { width:100% !important; height:360px !important; border-radius:12px }

    .controls { display:flex; gap:12px; margin-top:12px; align-items:center }
    .btn { background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; cursor:pointer; color:var(--muted); font-weight:700;
      transition: transform 120ms ease;}
    .btn:hover { transform: translateY(-3px) }

    .loader { color:var(--muted); font-size:0.9rem; display:flex; gap:10px; align-items:center }
    .dot { width:8px; height:8px; border-radius:50%; background:var(--neon-blue); box-shadow: 0 6px 20px rgba(0,194,255,0.09); animation: dot 1s infinite linear; }
    .dot:nth-child(2){ animation-delay: .12s }
    .dot:nth-child(3){ animation-delay: .24s }
    @keyframes dot{ 0%{ transform: translateY(0) } 50%{ transform: translateY(-6px) } 100%{ transform: translateY(0) } }

    footer { margin-top:22px; color:var(--muted); font-size:0.86rem; text-align:center }

    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
      .cards{order:2}
      .panel{order:1; margin-bottom:14px}
      canvas{height:260px !important}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo">SCAR
                        FACE</div>
      <div>
        <h1>Thermocouple Control</h1>
        <div class="subtitle">SPACE CLUB,RIT‚Ä¢ Live Data</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div id="statusIndicator" class="status" title="Live status">
        <div id="led" class="led off"></div>
        <div id="statusText" style="font-weight:700;color:#c8eefe">Offline</div>
      </div>
    </div>
  </header>

  <main class="grid">
    <div class="cards">
      <div id="card1" class="card">
        <div class="label">ENDCAP</div>
        <div id="temp1" class="value">-- <span class="unit">¬∞C</span></div>
        <div id="max1" class="max">Max: -- ¬∞C</div>
        <div style="position:absolute; right:12px; top:12px; color:var(--muted); font-weight:600; font-size:0.85rem">Sensor A</div>
      </div>

      <div id="card2" class="card">
        <div class="label">CASING</div>
        <div id="temp2" class="value">-- <span class="unit">¬∞C</span></div>
        <div id="max2" class="max">Max: -- ¬∞C</div>
        <div style="position:absolute; right:12px; top:12px; color:var(--muted); font-weight:600; font-size:0.85rem">Sensor B</div>
      </div>

      <div class="card" id="infoCard">
        <div class="label">Telemetry</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div>
            <div style="font-weight:700;font-size:1rem">Update Rate</div>
            <div class="meta" id="updateRate">-- ms</div>
          </div>
          <div>
            <div class="loader" id="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div style="margin-left:8px;color:var(--muted);font-weight:700">Fetching</div></div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="downloadCSV" class="btn">‚¨áÔ∏è Download CSV</button>
          <button id="clearData" class="btn">üßπ Clear Chart</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-head">
        <div>
          <div class="panel-title">Temperature Trend</div>
          <div class="meta">Live chart ‚Äî ENADCAP (blue) & CASING (orange)</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="meta">Last: <span id="lastSync">--</span></div>
        </div>
      </div>

      <canvas id="tempChart"></canvas>

      <div class="controls">
        <div class="meta">Chart window:</div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-window="30">30 pts</button>
          <button class="btn" data-window="100">100 pts</button>
          <button class="btn" data-window="300">300 pts</button>
        </div>
      </div>
    </div>
  </main>

  <footer>SPACE CLUB OFFICIAL ‚Ä¢ THERMO DATA</footer>

<script>
/* ------------------ CONFIG ------------------ */
const databaseURL = "https://thermo-f7b66-default-rtdb.firebaseio.com/";
let pollInterval = 500;      // ms between fetches
let chartWindow = 100000;        // default chart window
/* ------------------------------------------- */

const timestamps = [], temp1Data = [], temp2Data = [];
let lastTemperature = { t1: null, t2: null };
let pollingHandle = null;
let lastFetchTime = 0;

const led = document.getElementById('led');
const statusText = document.getElementById('statusText');
const loader = document.getElementById('loader');
const lastSync = document.getElementById('lastSync');
const updateRate = document.getElementById('updateRate');
const temp1El = document.getElementById('temp1');
const temp2El = document.getElementById('temp2');
const max1El = document.getElementById('max1');
const max2El = document.getElementById('max2');
const card1 = document.getElementById('card1');
const card2 = document.getElementById('card2');

const ctx = document.getElementById('tempChart').getContext('2d');
const g1 = ctx.createLinearGradient(0,0,0,400); g1.addColorStop(0,"rgba(0,194,255,0.32)"); g1.addColorStop(1,"rgba(0,194,255,0.02)");
const g2 = ctx.createLinearGradient(0,0,0,400); g2.addColorStop(0,"rgba(255,122,64,0.32)"); g2.addColorStop(1,"rgba(255,122,64,0.02)");

const tempChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: timestamps,
    datasets: [
      { label: 'ENDCAP (¬∞C)', data: temp1Data, borderColor: 'rgba(0,194,255,0.95)', backgroundColor: g1, borderWidth: 2.8, pointRadius: 3, tension: 0.28, fill:true },
      { label: 'CASING (¬∞C)', data: temp2Data, borderColor: 'rgba(255,122,64,0.95)', backgroundColor: g2, borderWidth: 2.8, pointRadius: 3, tension: 0.28, fill:true }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color: '#cfeffa' } } },
    scales: {
      x: { ticks: { color:'#9fbfdc' }, grid:{ color:'rgba(255,255,255,0.02)' } },
      y: { ticks: { color:'#9fbfdc' }, grid:{ color:'rgba(255,255,255,0.02)' } }
    }
  }
});

/* ------------------ FETCH + UPDATE ------------------ */
async function fetchLatest(){
  try {
    const res = await fetch(databaseURL+"thermocouples/readings/latest.json");
    const data = await res.json();
    if(!data) { markOffline(); return; }

    const t1 = Number(data.temp1), t2 = Number(data.temp2);
    const m1 = Number(data.max1_max), m2 = Number(data.max2_max);

    // STOP plotting if readings unchanged (system OFF)
    if(t1 === lastTemperature.t1 && t2 === lastTemperature.t2){
      markOffline();
      hideLoader();
      return;
    }

    // NEW readings ‚Üí update
    markLive();
    lastTemperature.t1 = t1; lastTemperature.t2 = t2;

    updateCard(temp1El, card1, t1);
    updateCard(temp2El, card2, t2);

    max1El.textContent = "Max: "+(isFinite(m1)? m1.toFixed(2)+" ¬∞C":"--");
    max2El.textContent = "Max: "+(isFinite(m2)? m2.toFixed(2)+" ¬∞C":"--");

    const ts = new Date();
    timestamps.push(ts.toLocaleTimeString());
    temp1Data.push(t1); temp2Data.push(t2);

    while(timestamps.length>chartWindow){ timestamps.shift(); temp1Data.shift(); temp2Data.shift(); }

    tempChart.update();
    lastSync.textContent = ts.toLocaleTimeString();
    updateRate.textContent = (Date.now()-lastFetchTime)+" ms";
    lastFetchTime = Date.now();
    hideLoader();

  } catch(err){
    console.error("Fetch error:", err);
    markOffline();
  }
}

function updateCard(el, cardEl, value){
  if(!isFinite(value)){ el.innerHTML="-- <span class='unit'>¬∞C</span>"; cardEl.classList.remove('warn','danger'); return; }
  const html = `${value.toFixed(2)} <span class="unit">¬∞C</span>`;
  el.innerHTML = html;

  if(value>=120){ cardEl.classList.add('danger'); cardEl.classList.remove('warn'); }
  else if(value>=80){ cardEl.classList.add('warn'); cardEl.classList.remove('danger'); }
  else { cardEl.classList.remove('warn','danger'); }
}

function markLive(){ led.classList.remove('off'); led.classList.add('live'); statusText.textContent="LIVE"; statusText.style.color="#c8eefe"; }
function markOffline(){ led.classList.remove('live'); led.classList.add('off'); statusText.textContent="OFFLINE"; statusText.style.color="#9aa6b3"; }
function hideLoader(){ loader.style.opacity=0; loader.style.pointerEvents='none'; }
function showLoader(){ loader.style.opacity=1; loader.style.pointerEvents='auto'; }

/* ------------------ CONTROLS ------------------ */
document.getElementById('downloadCSV').addEventListener('click', ()=>{
  if(!timestamps.length){ alert("No data to download yet."); return; }
  let csv="Time,Temp1(¬∞C),Temp2(¬∞C)\n";
  for(let i=0;i<timestamps.length;i++){ csv+=`"${timestamps[i]}",${temp1Data[i]},${temp2Data[i]}\n`; }
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="thermocouple_log.csv"; a.click();
});
document.getElementById('clearData').addEventListener('click', ()=>{
  if(!confirm("Clear chart data?")) return;
  timestamps.length=0; temp1Data.length=0; temp2Data.length=0; tempChart.update();
});
document.querySelectorAll('.controls .btn[data-window]').forEach(b=>{
  b.addEventListener('click', ()=>{
    chartWindow = Number(b.getAttribute('data-window'));
    while(timestamps.length>chartWindow){ timestamps.shift(); temp1Data.shift(); temp2Data.shift(); }
    tempChart.update();
  });
});

/* ------------------ START POLLING ------------------ */
showLoader();
fetchLatest();
if(pollingHandle) clearInterval(pollingHandle);
pollingHandle = setInterval(()=>{ showLoader(); fetchLatest(); }, pollInterval);

document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){ clearInterval(pollingHandle); pollingHandle=null; markOffline(); }
  else { if(!pollingHandle){ pollingHandle=setInterval(()=>{ showLoader(); fetchLatest(); }, pollInterval); fetchLatest(); } }
});
</script>
</body>
</html>
